!function(e){e.widget("ui.nestedSortable",e.extend({},e.ui.sortable.prototype,{options:{doNotClear:!1,expandOnHover:700,isAllowed:function(e,t,i){return!0},isTree:!1,listType:"ul",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"nestedSortable1",collapsedClass:"ui-nestedSortable-collapsed",disableNestingClass:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",expandedClass:"ui-nestedSortable-expanded",hoveringClass:"ui-nestedSortable-hovering",leafClass:"nestedSortable2"},_create:function(){return 0==this.noJumpFix&&this.element.height(this.element.height()),this.element.data("sortable",this.element.data("nestedSortable")),e.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(t){if(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var i=this.options,s=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<i.scrollSensitivity?this.scrollParent[0].scrollTop=s=this.scrollParent[0].scrollTop+i.scrollSpeed:t.pageY-this.overflowOffset.top<i.scrollSensitivity&&(this.scrollParent[0].scrollTop=s=this.scrollParent[0].scrollTop-i.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<i.scrollSensitivity?this.scrollParent[0].scrollLeft=s=this.scrollParent[0].scrollLeft+i.scrollSpeed:t.pageX-this.overflowOffset.left<i.scrollSensitivity&&(this.scrollParent[0].scrollLeft=s=this.scrollParent[0].scrollLeft-i.scrollSpeed)):(t.pageY-e(document).scrollTop()<i.scrollSensitivity?s=e(document).scrollTop(e(document).scrollTop()-i.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<i.scrollSensitivity&&(s=e(document).scrollTop(e(document).scrollTop()+i.scrollSpeed)),t.pageX-e(document).scrollLeft()<i.scrollSensitivity?s=e(document).scrollLeft(e(document).scrollLeft()-i.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<i.scrollSensitivity&&(s=e(document).scrollLeft(e(document).scrollLeft()+i.scrollSpeed))),!1!==s&&e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var l=this.items.length-1;l>=0;l--){var o=this.items[l],r=o.item[0],n=this._intersectsWithPointer(o);if(n&&!(r==this.currentItem[0]||this.placeholder[1==n?"next":"prev"]()[0]==r||e.contains(this.placeholder[0],r)||"semi-dynamic"==this.options.type&&e.contains(this.element[0],r))){if(this.direction=1==n?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(o))break;this._rearrange(t,o),this._clearEmpty(r),this._trigger("change",t,this._uiHash());break}}var h=this.placeholder[0].parentNode.parentNode&&e(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?e(this.placeholder[0].parentNode.parentNode):null,a=this._getLevel(this.placeholder),p=this._getChildLevels(this.helper),c=this.placeholder[0].previousSibling?e(this.placeholder[0].previousSibling):null;if(null!=c)for(;"li"!=c[0].nodeName.toLowerCase()||c[0]==this.currentItem[0];){if(!c[0].previousSibling){c=null;break}c=e(c[0].previousSibling)}return newList=document.createElement(i.listType),this.beyondMaxLevels=0,null!=h&&this.positionAbs.left<h.offset().left?(h.after(this.placeholder[0]),this._clearEmpty(h[0]),this._trigger("change",t,this._uiHash())):null!=c&&this.positionAbs.left>c.offset().left+i.tabSize?(this._isAllowed(c,a+p+1),c.children(i.listType).length||c[0].appendChild(newList),c.children(i.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",t,this._uiHash())):this._isAllowed(h,a+p),this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,i){if(this.beyondMaxLevels){for(var s=this.placeholder.parent().closest(this.options.items),l=this.beyondMaxLevels-1;l>0;l--)s=s.parent().closest(this.options.items);this.placeholder.removeClass(this.options.errorClass),s.after(this.placeholder),this._trigger("change",t,this._uiHash())}e.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(t){var i=this._getItemsAsjQuery(t&&t.connected),s=[];return t=t||{},e(i).each(function(){var i=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/),l=(e(t.item||this).parent(t.listType).parent("li").attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);i&&s.push((t.key||i[1]+"["+(t.key&&t.expression?i[1]:i[2])+"]")+"="+(l?t.key&&t.expression?l[1]:l[2]:"root"))}),!s.length&&t.key&&s.push(t.key+"="),s.join("&")},toHierarchy:function(t){(t=t||{}).startDepthCount;var i=[];return e(this.element).children("li").each(function(){var s=function i(s){var l=(e(s).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);if(null!=l){var o={id:l[2]};return e(s).children(t.listType).children("li").length>0&&(o.children=[],e(s).children(t.listType).children("li").each(function(){var t=i(e(this));o.children.push(t)})),o}}(e(this));i.push(s)}),i},toArray:function(t){var i=(t=t||{}).startDepthCount||0,s=[],l=2;return s.push({item_id:"root",parent_id:"none",depth:i,left:"1",right:2*(e("li",this.element).length+1)}),e(this.element).children("li").each(function(){l=function l(o,r,n){right=n+1;e(o).children(t.listType).children("li").length>0&&(r++,e(o).children(t.listType).children("li").each(function(){right=l(e(this),r,right)}),r--);id=e(o).attr(t.attribute||"id").match(t.expression||/(.+)[-=_](.+)/);r===i+1?pid="root":(parentItem=e(o).parent(t.listType).parent("li").attr("id").match(t.expression||/(.+)[-=_](.+)/),pid=parentItem[2]);null!=id&&s.push({item_id:id[2],parent_id:pid,depth:r,left:n,right:right});return n=right+1}(this,i+1,l)}),s=s.sort(function(e,t){return e.left-t.left})},_clear:function(t,i){e.ui.sortable.prototype._clear.apply(this,arguments);for(var s=this.items.length-1;s>=0;s--){var l=this.items[s].item[0];this._clearEmpty(l)}return!0},_clearEmpty:function(e){e.children[1]&&0==e.children[1].children.length&&e.removeChild(e.children[1])},_getLevel:function(e){var t=1;if(this.options.listType)for(var i=e.closest(this.options.listType);!i.is(".ui-sortable");)t++,i=i.parent().closest(this.options.listType);return t},_getChildLevels:function(t,i){var s=this,l=this.options,o=0;return i=i||0,e(t).children(l.listType).children(l.items).each(function(e,t){o=Math.max(s._getChildLevels(t,i+1),o)}),i?o+1:o},_isAllowed:function(e,t){var i=this.options;null!=e&&e.hasClass(i.disableNesting)?(this.placeholder.addClass(i.errorClass),i.maxLevels<t&&0!=i.maxLevels?this.beyondMaxLevels=t-i.maxLevels:this.beyondMaxLevels=1):i.maxLevels<t&&0!=i.maxLevels?(this.placeholder.addClass(i.errorClass),this.beyondMaxLevels=t-i.maxLevels):(this.placeholder.removeClass(i.errorClass),this.beyondMaxLevels=0)}})),e.ui.nestedSortable.prototype.options=e.extend({},e.ui.sortable.prototype.options,e.ui.nestedSortable.prototype.options)}(jQuery);